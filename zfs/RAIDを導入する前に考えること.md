<!-- https://qiita.com/belgianbeer/items/42bd1dd5c35c96d808a8 -->
# RAIDを導入する前に考えること

## はじめに

実体験から学ぶことは多いわけで、ここではZFSのRAIDZで少々失敗したお話。ZFSでの話ではあるが、特にZFSに依存した話ではなく同様のハードウェアでRAID 5や6を構成すれば同じ問題が起きるはずなので、参考になれば幸いである。

## 事の起こり、RAIDZ2の導入

3年ぐらい前の話になるが、会社でUSB 3.0接続でHDDを5台入る筐体に1TB HDDを積んだものを用意してもらった。つまり総容量は5TBである。製品はセンチュリーの「[裸族の集合住宅5Bay SATA6G USB3.0&eSATA Ver.2](https://www.century.co.jp/products/crsj535eu3s6g2.html)」で、インターフェースにはUSB 3.0の他にeSATAも用意されていたが、サーバー側にはeSATAは無いためUSB 3.0で接続した。

当時の要望として容量の面では1TBもあれば用が足りるため、5台あればRAIDZ2を構成しても3TB確保できることから、RAIDZ2として構成したのであった。

## RAIDZ

ZFSではRAIDを構成する場合RAIDZという名称で、一般的なRAIDに当てはめると、RAIDZがRAID 5、RAIDZ2がRAID 6に相当する。ここで少しだけRAID 5、6について説明する。

RAID 5 or 6ではストレージデバイス(以下ストレージ)を一定サイズ(話を単純にするために1MBとする)のブロックで分割し、ストレージの台数分のブロックをまとめ(5台だと5MB)、パリティを割り当てて管理する。RAID 5がシングルパリティ、6がダブルパリティであるため、5台のストレージだとRAID 5ではデータ分が4MB、パリティ分が1MB、RAID 6ではデータ分が3MB、パリティが2MBとなる。この管理単位を1MBづつ各ストレージに分散して配置することで、ストレージシステムの信頼性と冗長性を確保する。具体的にはRAID 6であれば、ストレージが1台壊れてもデータの整合性が保証でき、2台壊れてもデータの継続性が保証できる。

しかしながら一般的なRAID 5や6には、管理サイズより小さなサイズの書き込みには大きなペナルティが発生する。例えば上記構成のRAID 6で1MB分のデータを更新するためには、一旦管理単位のデータ3MB、パリティ2MB分のデータを読み出し、データの整合性を確認後に1MB分更新したデータを改めて書き戻す必要がある。つまり1MBの書き込みのために、5MBのデータの読み込みと同容量のデータの書き戻しが必要になるのである。多くの場合書き込みはOSのバッファによってアプリ側からのペナルティは小さいが、データの書き込みのために読み込みが必要になるのはパフォーマンスの面からは無視できないものとなる。実際の市販の多くのRAIDシステムでは、内部に大容量のバッファメモリを用意することでこのデータ書き込み時のパフォーマンス低下の問題を回避している。

ZFSでのRAIDZでは、データの管理単位を一定の固定サイズではなく可変サイズとしてコピー・オン・ライトで動作するため、データの書き込みの際に既存データの読み出しの必要が無い。このため、RAIDZでは、データの書き込みに大きなペナルティは発生せず、特別のバッファメモリ等を利用しなくても実用上十分な書き込み速度が得られる。

## データの読み出しが遅い！

ZFSの経験はそれなりにあるものの、RAIDZ2を利用するのはこのシステムが初めてであった。実際にRAIDZ2を使い始めてすぐに気づいたのは、一般的なHDDに比べてデータの読み出しに時間がかかるということである。

考えてみれば当然の話で、5台のHDDでRAIDZ2であれば、3MB分のデータを読み込むにはデータ分に加えてパリティ分2MBを読み出す必要がある。つまり単純に1台のHDDから3MBのデータを読み出すのに比較し、5/3(1.67)倍の読み出し時間が必要になる(パリティの計算時間はHDDのアクセス時間に比べると無視できる)。

5台のHDDそれぞれを並行で同時に読み出すことが出来れば大きなペナルティにはならないはずであるが、ここで使っているUSB接続のHDDでは1台づつ順番に読み出しているようである(観察に基づく推測)。SATAやSAS接続のHDDであればまた違った動作になる。

## USB 3.0接続なのに根本的に遅い！

データの読み出しが遅いことは把握していたものの、一旦運用を始めたサーバーでは簡単に構成変更はできず、そのまま使い続けてきた。そして3年近く経過した半年ほど前の話になるが、HDDの筐体はそのままでサーバー側を交換することになり、新たなサーバにOSをインストールして、今まで使っていたものをそのまま接続した。

以前からサーバーではMacのタイムマシンバックアップを行っていたのだが新サーバーにはSATAで1TBのHDDが内蔵されていたので、ある日試しに内蔵HDDにタイムマシンバックアップを行ってみてその結果に愕然とした。1回あたりのタイムマシンのバックアップ時間が今までは30分～1時間、あるいはもっとかかっていたものが、ほんの数分程度(大部分が10分以下)で済むようになったのである。

タイムマシンのバックアップの挙動を観測すると、実際のバックアップデータの書き込み前に前回のバックアップとの比較と思われる大量の比較的小さなデータの読み出しが発生している。ここでRAIDでのHDD読み出しの挙動を考えてみると、5台構成のRAIDZ2(RAID 6)であればどんなに小さなデータを読み出す場合であっても5 台のHDDからの読み出しが必要となるのは明らかである。これに対して1台のHDDであれば、読み出しは1台分済む。

実際のデータの読み出しでは、HDDに対して読み込みのコマンドの発行とデータの取り込みが必要である。コマンドの発行に必要な時間と実際にデータ転送が始まるまでの時間をA、データの転送に必要な時間をBすると、データの読み込みに必要な時間は次のようになる。

|  |  |
|:-:|:-:|
| 1台のHDD  |A + B    |
| 5台構成のRAIDZ2 (RAID 6)  | (A' * 5) + B  |

これだけでも明らかに5台構成のRAIDは不利であるが、さらに使っている筐体のUSB 3.0とSATAでは A と A' の時間には大きな差があるように思える(機会があれば計測したい)。

USB 3.0のインターフェースの速度は 5Gbpsであり、SATAの6Gbpsと比較すると遅いとは言え、そこまで大きな差ではない。しかしこの筐体のUSB接続のHDDの場合、HDD自体のインターフェースはSATAであるため、内部でUSB⇔SATAのインターフェース変換をおこなっている。そのせいかどうまでは不明だが、USB経由のHDDアクセスのレイテンシは、SATAのレイテンシに比べて相当大きいのではないかと推測する。

## 結局どうしたの？

これらの現実を把握したこともあり、タイムマシンバックアップはサーバーの内蔵HDDだけで行うように変更した。それと共にRAIDZ2のHDD箱のデータを整理し、容量的にも問題ないので、4台のHDDを組み合わせてRAID 1+0に構成変更を行った。HDDが1台余るのでスペアHDDとして割り当てた。以前のRAIDZ2に比べると、読み書きのパフォーマンスは一回りよくなったようである。

## まとめ

長文となってしまったが結局言いたいことは、こんなところだろうか。

この筐体をUSB接続でRAIDによる冗長性を確保する場合は、5や6は避けRAID 1つまりミラーで構成するのが得策である

## その後

初めに書いたように当記事での**USB接続**はあくまでも「[裸族の集合住宅5Bay SATA6G USB3.0&eSATA Ver.2](https://www.century.co.jp/products/crsj535eu3s6g2.html)」での話である。その後**実際にこの筐体をeSATA接続で使用したところ、USB接続とはうって変わって十分なパフォーマンスを発揮しRAIDZ2で使ってもパフォーマンスはまったく悪化しないどころか、並行に動作するため台数を増やした場合のパフォーマンスの向上も確認できた**。

実際に計測した結果は「[ストレージインターフェースにおけるSATAとUSBの性能差](https://qiita.com/belgianbeer/items/9f963d6b33fd4124b45f)」にまとめてある。

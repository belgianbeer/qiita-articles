# USBãƒ¡ãƒ¢ãƒªã§ ZFS ï¼

## ZFSã®ç¿’å¾—ã«ã¯USBãƒ¡ãƒ¢ãƒªãŒæœ€é©

æ™‚ã€…ZFSã‚’å‹‰å¼·ã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã„ã„ã®ï¼Ÿã¨èã‹ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã™ãŒã€ç­†è€…ã®ãŠã™ã™ã‚ã¯USBãƒ¡ãƒ¢ãƒªã§è©¦ã™ã“ã¨ã§ã™ã€‚

ZFSã«ã‚ˆã‚‹RAIDæ§‹æˆã‚’å®Ÿé¨“ã™ã‚‹å ´åˆè¤‡æ•°ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‡ãƒã‚¤ã‚¹ã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€SSDã‚„HDDã§RAIDæ§‹æˆã‚’è©¦ã›ã‚‹å°æ•°ã‚’ãã‚ãˆã‚‹ã®ã¯å¤§å¤‰ã§ã™ã€‚USBãƒ¡ãƒ¢ãƒªã§ã‚ã‚Œã°USBãƒãƒ–ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§è¤‡æ•°ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’è©¦ã›ã¦ä¾¡æ ¼ã¨ã‚¹ãƒšãƒ¼ã‚¹ã®ç‚¹ã§æœ‰åˆ©ã§ã€ã•ã‚‰ã«ç¨¼åƒä¸­ã«ã„ããªã‚ŠæŠœãç­‰ã®ä¹±æš´ãªè©¦é¨“ã‚‚å®Ÿç¾ã§ãã€ZFSã§ã®RAIDæ§‹æˆã‚’ç¿’å¾—ã™ã‚‹ã«ã¯ã‚ã‚‹æ„å‘³ã†ã£ã¦ã¤ã‘ã¨è¨€ãˆã¾ã™ã€‚ç‰¹ã«LEDä»˜ãã®USBãƒ¡ãƒ¢ãƒªã§ã‚ã‚Œã°ã‚¢ã‚¯ã‚»ã‚¹ã®æ§˜å­ã‚‚ç›®è¦–ã§ç¢ºèªã§ãã‚‹ã®ã§è¦‹ã¦ã„ã¦ã‚‚æ¥½ã—ã„ã§ã™ã€‚ğŸ™‚

ã“ã“ã§ã¯USBãƒ¡ãƒ¢ãƒªã‚’çµ„ã¿åˆã‚ã›ã¦ã€ZFSã«ã‚ˆã‚‹æ§˜ã€…ãªRAIDã‚’æ§‹æˆæ¯ã®ç‰¹å¾´ã‚’å«ã‚ã¦è¨­å®šã—ã¦ã¿ã¾ã™ã€‚

ãªãŠZFSã«USBãƒ¡ãƒ¢ãƒªã‚’ä½¿ã†ã¨ã„ã†å…ƒãƒã‚¿ã¯ã€éå»ã«ã‚µãƒ³ãƒ»ãƒã‚¤ã‚¯ãƒ­ã‚·ã‚¹ãƒ†ãƒ ã‚ºã®ã€Œã‚„ã£ã±ã‚Š Sun ãŒã‚¹ã‚­ï¼ã€ã¨ã„ã†Solarisã®æ©Ÿèƒ½ãªã©ã‚’ç´¹ä»‹ã™ã‚‹ãƒ–ãƒ­ã‚°ã§ã€æœ¬è¨˜äº‹ã¨åŒã˜ãã€ŒUSBãƒ¡ãƒ¢ãƒªã§ ZFS ï¼ã€ã®ã‚¿ã‚¤ãƒˆãƒ«ã§æŠ•ç¨¿ã•ã‚ŒãŸã‚‚ã®ã§ã™[^yappari]ã€‚

[^yappari]:2007å¹´5æœˆã«æŠ•ç¨¿ã•ã‚ŒãŸã‚‚ã®ã§ã‚µã‚¤ãƒˆã¯ã™ã§ã«é–‰é–ã•ã‚Œã¦ã„ã¾ã™ãŒã€å½“æ™‚ã®è¨˜äº‹ã¯[ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ç¢ºèª](https://web.archive.org/web/20071013152120/http://blogs.sun.com/yappri/entry/usb_zfs)ã§ãã¾ã™ã€‚ã“ã®è¨˜äº‹ã‚’è¦‹ã¦æ•°å¹´å¾Œã«å®Ÿéš›ã«è‡ªåˆ†ã§è©¦ã—ãŸã¨ãã¯ã€ãªãœã‹USB HDDãŒè¤‡æ•°ã‚ã£ãŸãŸã‚ã€USBãƒ¡ãƒ¢ãƒªã§ã¯ç„¡ã[USB HDDã§å®Ÿé¨“](https://www.facebook.com/photo?fbid=685848231475753&set=a.148549968538918)ã—ã¾ã—ãŸã€‚

## USBãƒ¡ãƒ¢ãƒª 4å€‹ ã¨ USBãƒãƒ–ã®æº–å‚™

å®Ÿé¨“ã«ä½¿ã†USBãƒ¡ãƒ¢ãƒªã§ã™ãŒã€ç­†è€…ã®å ´åˆå°‘ã—å‰ã«100å††ã‚·ãƒ§ãƒƒãƒ—ã§USBã®ãƒ¡ãƒ¢ãƒªã‚«ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ã‚’å…¥æ‰‹ã—ã¦ã„ã¾ã—ãŸã€‚ä½¿ã£ã¦ã¿ã‚‹ã¨ã‚¢ã‚¯ã‚»ã‚¹LEDä»˜ãã§ä¾¿åˆ©ã ã£ãŸã®ã§ã€ä»Šå›3å€‹è¿½åŠ è³¼å…¥ã—ã¦æ‰‹å…ƒã«ã‚ã£ãŸSDã‚«ãƒ¼ãƒ‰ã‚„microSDã‚«ãƒ¼ãƒ‰ã¨çµ„ã¿åˆã‚ã›ã¦USBãƒ¡ãƒ¢ãƒªã«ã—ã¾ã™ã€‚4å€‹ã‚ã‚Œã°RAID 6ã‚„RAID 10(ã‚¤ãƒã‚¼ãƒ­)ã‚‚è©¦ã›ã‚‹ã®ã§ã€å®Ÿé¨“ã«ã¯ã‚‚ã£ã¦ã“ã„ã¨ãªã‚Šã¾ã™ã€‚

USBãƒãƒ–ã¯æ‰‹æŒã¡ã®ã‚‚ã®ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚ã“ã®å½¢ã ã¨ãƒ¡ãƒ¢ãƒªã‚«ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãŒç›¸äº’ã«å¹²æ¸‰ã›ãšã«é…ç½®ã§ãã¾ã™(ç¬‘)ã€‚ç­†è€…ã®å ´åˆã¯microSDã‚«ãƒ¼ãƒ‰ã€SDã‚«ãƒ¼ãƒ‰å…±2GBã®ã‚‚ã®ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

å®Ÿéš›ã«PCã«æ¥ç¶šã™ã‚‹ã¨ã€æ¬¡ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚ˆã†ã«ãƒ‡ãƒã‚¤ã‚¹ã‚’1å€‹ã¥ã¤èªè­˜ã™ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![DSC07194.GIF](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/130638/cac6d3a9-41e0-403a-8f60-cc7732a14f8b.gif)

## USBãƒ¡ãƒ¢ãƒªã®åˆæœŸåŒ–

æ–°å“ã®USBãƒ¡ãƒ¢ãƒªã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã¯å®¹é‡ã«ã‚‚ã‚ˆã‚Šã¾ã™ãŒå¤šãã¯MBR(DOS)å½¢å¼ã§å…¨ä½“ã‚’FAT32ã‚ã‚‹ã„ã¯exFATã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸçŠ¶æ…‹ã¨ãªã£ã¦ã„ã¾ã™ã€‚MBRå½¢å¼ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’ãã®ã¾ã¾ä½¿ã†ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ãŒã€æŸ”è»Ÿãªç®¡ç†ã®ãŸã‚ã«GPTã§ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’ä½œã‚Šç›´ã—ã¾ã™ã€‚GPTã§ã‚ã‚Œã°ã€ãã‚Œãã‚Œã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã«ãƒ©ãƒ™ãƒ«(åå‰)ã‚’ã¤ã‘ã‚‰ã‚Œã‚‹ã®ã§ã€usb0ï½usb3ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚

### FreeBSDã§ã®USBãƒ¡ãƒ¢ãƒªã®åˆæœŸåŒ–

FreeBSDã®å ´åˆã€é€šå¸¸USBãƒ¡ãƒ¢ãƒªã¯ /dev/da0 ï½ /dev/da3 ã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚ã‚‚ã—ã™ã§ã«da0ã‚„da1ã®ãƒ‡ãƒã‚¤ã‚¹ãŒå­˜åœ¨ã™ã‚‹ãªã‚‰ã€ç•ªå·ã¯ãã®å¾Œã‚ã«ãšã‚Œã¾ã™ã€‚ã“ã“ã§ã¯da0ã‹ã‚‰da3ã¾ã§ã§èªè­˜ã•ã‚ŒãŸã¨ã—ã¦èª¬æ˜ã—ã¾ã™ã€‚

FreeBSDã§ã®USBãƒ¡ãƒ¢ãƒªã®åˆæœŸåŒ–ã‚’da0ã«å¯¾ã—ã¦è¡Œã†å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```console
$ gpart destroy -F da0                  # (1) æ—¢å­˜ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¯ãƒªã‚¢
$ gpart create -s gpt da0               # (2) gptå½¢å¼ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
$ gpart add -t freebsd-zfs -l usb0 da0  # (3) ZFSç”¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ä½œæˆ ãƒ©ãƒ™ãƒ«åã¯ã€Œusb0ã€
$ zpool labelclear -f da0p1             # (4) ZFSã®ãƒ—ãƒ¼ãƒ«ãƒ©ãƒ™ãƒ«ã®æ¶ˆå» (åˆã‚ã¦ä½¿ã†USBãƒ¡ãƒ¢ãƒªã®å ´åˆã¯ä¸è¦)
$ gpart show da0                        # (5) ä½œã£ãŸãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ç¢ºèª
=>     40  3987376  da0  GPT  (1.9G)
       40  3987376    1  freebsd-zfs  (1.9G)

$
```

ã“ã“ã§ã¯da0ã®microSDã‚«ãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™ãŒã€da1ã®SDã‚«ãƒ¼ãƒ‰ã«å¯¾ã—ã¦åŒæ§˜ã«åˆæœŸåŒ–ã—ãŸã¨ã“ã‚å…¬ç§°ã¯åŒå®¹é‡ã§ã™ãŒå®Ÿå®¹é‡ã«å°‘ã—å·®ãŒã‚ã‚Šã¾ã—ãŸã€‚

```console
$ gpart show da1                        # da1ã®SDã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ç¢ºèª
=>     40  3862448  da1  GPT  (1.8G)
       40  3862448    1  freebsd-zfs  (1.8G)

$
```

RAID Z(å¾Œè¿°)ã‚’æ§‹æˆã™ã‚‹å ´åˆã¯åŒå®¹é‡ã§ãªã„å ´åˆã«æ³¨æ„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€å®¹é‡ã®å°ã•ã„SDã‚«ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦microSDã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºã‚’å°‘ã—æ¸›ã‚‰ã™ãŸã‚ã€`gpart add`ã«`-s`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦SDã‚«ãƒ¼ãƒ‰ã®3862448ãƒ–ãƒ­ãƒƒã‚¯(1ãƒ–ãƒ­ãƒƒã‚¯ã¯512ãƒã‚¤ãƒˆ)ã«åˆ¶é™ã—ã¾ã™ã€‚

å®Ÿéš›ã«ã¯4å€‹ã®USBãƒ¡ãƒ¢ãƒªã‚’åˆæœŸåŒ–ã™ã‚‹ãŸã‚ã€æ¬¡ã®ã‚ˆã†ã«ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œã£ã¦å®Ÿè¡Œã—ã¾ã—ãŸã€‚

```console
$ cat usbmem-init-freebsd     # ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å†…å®¹ã®è¡¨ç¤º
#!/bin/sh

for i in 0 1 2 3
do
    gpart destroy -F da$i
    sleep 1
    gpart create -s gpt da$i
    sleep 1
    gpart add -t freebsd-zfs -s 3862448 -l usb$i da$i
    # sleep 1
    # zpool labelclear -f da${i}p1
done
$ ./usbmem-init-freebsd     # ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
da0 destroyed
da0 created
da0p1 added
da1 destroyed
da1 created
da1p1 added
da2 destroyed
da2 created
da2p1 added
da3 destroyed
da3 created
da3p1 added
$ ls /dev/gpt/usb?     # ç”¨æ„ã—ãŸãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã‚’ç¢ºèªã™ã‚‹
/dev/gpt/usb0   /dev/gpt/usb1   /dev/gpt/usb2   /dev/gpt/usb3
$ gpart show -l da0 da1 da2 da3     # å‡ºæ¥ãŸãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’ãƒ©ãƒ™ãƒ«ã§è¡¨ç¤º

$
```

å„ã‚³ãƒãƒ³ãƒ‰ã®é–“ã«`sleep 1`ãŒã‚ã‚‹ã®ã¯ã€ã“ã®ã‚ˆã†ãªæ“ä½œã§ã¯ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã¯ã™ãã«çµ‚äº†ã™ã‚‹ã®ã«USBãƒ¡ãƒ¢ãƒªã¸ã®æ›¸ãè¾¼ã¿ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã£ã¦ã€ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ãŸã¦ç¶šã‘ã«è¡Œã†ã¨ãƒˆãƒ©ãƒ–ãƒ«ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã®å›é¿ã—ã¦ã„ã¾ã™ã€‚

### Linuxã§ã®USBãƒ¡ãƒ¢ãƒªã®åˆæœŸåŒ–

Linuxã®å ´åˆã€é€šå¸¸USBãƒ¡ãƒ¢ãƒªã¯ /dev/sdb ï½ /dev/sde ã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹ã¯ãšãªã®ã§(ã™ã§ã«sdbã‚„sdcã®ãƒ‡ãƒã‚¤ã‚¹ãŒå­˜åœ¨ã™ã‚‹ãªã‚‰ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ãšã‚Œã‚‹)ã€ãã‚Œã‚’å‰æã«èª¬æ˜ã—ã¾ã™ã€‚

Linuxã§ã®USBãƒ¡ãƒ¢ãƒªã®åˆæœŸåŒ–ã‚’sdbã«å¯¾ã—ã¦è¡Œã†å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```console
$ wipefs -a /dev/sdb                        # (1) æ—¢å­˜ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¯ãƒªã‚¢
$ echo 'label: gpt' | sfdisk -q /dev/sdb    # (2) gptå½¢å¼ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
$ echo "type=6A898CC3-1DD2-11B2-99A6-080020736631, name=usb${j}, size=3858432" | sfdisk -q /dev/sd${i}
$                                           # (3) ZFSç”¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ä½œæˆ ãƒ©ãƒ™ãƒ«åã¯ã€Œusb0ã€
$ zpool labelclear -f /dev/sdb1             # (4) ZFSã®ãƒ—ãƒ¼ãƒ«ãƒ©ãƒ™ãƒ«ã®æ¶ˆå» (åˆã‚ã¦ä½¿ã†USBãƒ¡ãƒ¢ãƒªã®å ´åˆã¯ä¸è¦)
$ sfdisk --list /dev/sdb                    # (5) ä½œã£ãŸãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ç¢ºèª
Disk /dev/sdb: 1.9 GiB, 2041577472 bytes, 3987456 sectors
Disk model: Storage Device
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: CBE6E991-0D89-DB49-B7E5-B2BD8FA00C89
$
```

å®Ÿéš›ã«ã¯FreeBSDã®å ´åˆã¨åŒæ§˜ã«ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œã£ã¦å®Ÿè¡Œã—ã¾ã—ãŸã€‚

```console
$ cat usbmem-init-linux
#!/bin/sh

j=0
for i in b c d e
do
    wipefs -a /dev/sd${i}
    sleep 1
    echo 'label: gpt' | sfdisk -q /dev/sd${i}
    sleep 1
    # sleep 1
    # zpool labelclear -f /dev/sd${i}1
    j=$((j + 1))
done
$ ./usbmem-init-linux
$ ls /dev/disk/by-partlabel/usb?     # ç”¨æ„ã—ãŸãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®å­˜åœ¨ã‚’ç¢ºèª
/dev/disk/by-partlabel/usb0  /dev/disk/by-partlabel/usb2
/dev/disk/by-partlabel/usb1  /dev/disk/by-partlabel/usb3
$
```


![DSC07199.GIF](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/130638/20258830-ccf2-459c-8937-a41ac6ae0c9f.gif)
